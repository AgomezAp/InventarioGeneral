<app-navbar></app-navbar>

<div class="consumible-container">
  <div class="form-wrapper">
    <!-- Header -->
    <header class="page-header">
      <div class="header-content">
        <button
          class="btn-back"
          (click)="cancelar()"
          aria-label="Volver"
          title="Volver al listado"
        >
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <div class="header-badge" [ngClass]="'badge-' + tipoInventario">
            <i class="pi" [ngClass]="iconoTipo"></i>
            <span>{{ tipoInventario | titlecase }}</span>
          </div>
          <h1>
            <i class="pi pi-plus-circle"></i>
            Agregar Artículo de {{ tituloTipo }}
          </h1>
          <p class="subtitle">Complete la información del nuevo artículo</p>
        </div>
      </div>
      <!-- Indicador de progreso visual -->
      <div class="header-progress">
        <div class="progress-step completed">
          <span class="step-number">1</span>
          <span class="step-label">Información</span>
        </div>
        <div class="progress-line"></div>
        <div
          class="progress-step"
          [class.completed]="consumibleForm.get('stockActual')?.valid"
        >
          <span class="step-number">2</span>
          <span class="step-label">Inventario</span>
        </div>
        <div class="progress-line"></div>
        <div
          class="progress-step"
          [class.completed]="consumibleForm.get('proveedor')?.value"
        >
          <span class="step-number">3</span>
          <span class="step-label">Proveedor</span>
        </div>
      </div>
    </header>

    <form
      [formGroup]="consumibleForm"
      (ngSubmit)="onSubmit()"
      class="consumible-form"
    >
      <!-- Sección: Información Básica -->
      <section class="section-card">
        <div class="section-card-header">
          <div class="section-icon">
            <i class="pi pi-info-circle"></i>
          </div>
          <div class="section-title">
            <h3>Información Básica</h3>
            <p>Datos principales del artículo</p>
          </div>
        </div>
        <div class="section-card-body">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre">
                Nombre del Artículo <span class="required">*</span>
              </label>
              <input
                type="text"
                id="nombre"
                formControlName="nombre"
                [placeholder]="
                  tipoInventario === 'aseo'
                    ? 'Ej: Jabón líquido antibacterial'
                    : 'Ej: Resmas de papel carta'
                "
                class="custom-input"
                [class.invalid]="isFieldInvalid('nombre')"
                [class.valid]="
                  consumibleForm.get('nombre')?.valid &&
                  consumibleForm.get('nombre')?.touched
                "
              />
              <span class="field-hint" *ngIf="!isFieldInvalid('nombre')">
                Ingrese un nombre descriptivo y único
              </span>
              <span class="error-message" *ngIf="isFieldInvalid('nombre')">
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("nombre") }}
              </span>
            </div>

            <div class="form-group">
              <label for="categoria">
                Categoría <span class="required">*</span>
              </label>
              <div class="custom-select-wrapper">
                <select
                  id="categoria"
                  formControlName="categoria"
                  class="custom-select"
                  [class.invalid]="isFieldInvalid('categoria')"
                  [class.valid]="
                    consumibleForm.get('categoria')?.valid &&
                    consumibleForm.get('categoria')?.touched
                  "
                >
                  <option value="" disabled>Seleccione una categoría</option>
                  <option *ngFor="let cat of categorias" [value]="cat">
                    {{ cat }}
                  </option>
                </select>
                <i class="pi pi-chevron-down select-arrow"></i>
              </div>
              <span class="error-message" *ngIf="isFieldInvalid('categoria')">
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("categoria") }}
              </span>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion">
              Descripción
              <span class="optional-badge">Opcional</span>
            </label>
            <textarea
              id="descripcion"
              formControlName="descripcion"
              rows="3"
              placeholder="Detalles adicionales del artículo como marca, presentación, características especiales..."
              class="custom-textarea"
              maxlength="500"
            ></textarea>
            <span
              class="char-counter"
              *ngIf="consumibleForm.get('descripcion')?.value"
            >
              {{ consumibleForm.get("descripcion")?.value?.length || 0 }}/500
            </span>
          </div>
        </div>
      </section>

      <!-- Sección: Inventario y Stock -->
      <section class="section-card">
        <div class="section-card-header">
          <div class="section-icon">
            <i class="pi pi-box"></i>
          </div>
          <div class="section-title">
            <h3>Control de Inventario</h3>
            <p>Configure los niveles de stock</p>
          </div>
        </div>
        <div class="section-card-body">
          <div class="form-row">
            <div class="form-group">
              <label for="unidadMedida">
                Unidad de Medida <span class="required">*</span>
              </label>
              <div class="custom-select-wrapper">
                <select
                  id="unidadMedida"
                  formControlName="unidadMedida"
                  class="custom-select"
                  [class.invalid]="isFieldInvalid('unidadMedida')"
                >
                  <option
                    *ngFor="let unidad of unidadesMedida"
                    [value]="unidad.value"
                  >
                    {{ unidad.label }}
                  </option>
                </select>
                <i class="pi pi-chevron-down select-arrow"></i>
              </div>
              <span
                class="error-message"
                *ngIf="isFieldInvalid('unidadMedida')"
              >
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("unidadMedida") }}
              </span>
            </div>

            <div class="form-group">
              <label for="stockActual">
                Stock Actual <span class="required">*</span>
              </label>
              <input
                type="number"
                id="stockActual"
                formControlName="stockActual"
                min="0"
                placeholder="0"
                class="custom-input"
                [class.invalid]="isFieldInvalid('stockActual')"
              />
              <span class="error-message" *ngIf="isFieldInvalid('stockActual')">
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("stockActual") }}
              </span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="stockMinimo">
                Stock Mínimo <span class="required">*</span>
                <button
                  type="button"
                  class="info-tooltip"
                  pTooltip="Se generará una alerta cuando el stock baje de este valor"
                  tooltipPosition="top"
                >
                  <i class="pi pi-info-circle"></i>
                </button>
              </label>
              <input
                type="number"
                id="stockMinimo"
                formControlName="stockMinimo"
                min="0"
                placeholder="5"
                class="custom-input"
                [class.invalid]="isFieldInvalid('stockMinimo')"
              />
              <span class="error-message" *ngIf="isFieldInvalid('stockMinimo')">
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("stockMinimo") }}
              </span>
            </div>

            <div class="form-group">
              <label for="stockMaximo">
                Stock Máximo
                <span class="optional-badge">Opcional</span>
                <button
                  type="button"
                  class="info-tooltip"
                  pTooltip="Cantidad máxima recomendada en almacén"
                  tooltipPosition="top"
                >
                  <i class="pi pi-info-circle"></i>
                </button>
              </label>
              <input
                type="number"
                id="stockMaximo"
                formControlName="stockMaximo"
                min="0"
                placeholder="100"
                class="custom-input"
              />
            </div>
          </div>

          <!-- Stock Tip mejorado -->
          <div class="stock-tip">
            <div class="tip-icon">
              <i class="pi pi-lightbulb"></i>
            </div>
            <div class="tip-content">
              <strong>Consejo:</strong>
              <p>
                El sistema le alertará automáticamente cuando el stock actual
                sea menor o igual al stock mínimo configurado.
              </p>
            </div>
          </div>

          <!-- Preview visual del stock -->
          <div
            class="stock-preview"
            *ngIf="consumibleForm.get('stockActual')?.value !== null"
          >
            <div class="stock-bar">
              <div
                class="stock-bar-fill"
                [style.width.%]="getStockPercentage()"
                [class.low]="isStockLow()"
                [class.ok]="!isStockLow()"
              ></div>
              <div
                class="stock-min-marker"
                [style.left.%]="getStockMinPercentage()"
                *ngIf="consumibleForm.get('stockMinimo')?.value"
              ></div>
            </div>
            <div class="stock-labels">
              <span>0</span>
              <span class="stock-current">
                Actual: {{ consumibleForm.get("stockActual")?.value || 0 }}
              </span>
              <span>{{ consumibleForm.get("stockMaximo")?.value || 100 }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Sección: Proveedor y Precio -->
      <section class="section-card">
        <div class="section-card-header">
          <div class="section-icon">
            <i class="pi pi-truck"></i>
          </div>
          <div class="section-title">
            <h3>Información de Proveedor</h3>
            <p>Datos de compra y ubicación</p>
          </div>
        </div>
        <div class="section-card-body">
          <div class="form-row">
            <div class="form-group">
              <label for="proveedor">
                Proveedor
                <span class="optional-badge">Opcional</span>
              </label>
              <input
                type="text"
                id="proveedor"
                formControlName="proveedor"
                placeholder="Nombre del proveedor"
                class="custom-input"
              />
            </div>

            <div class="form-group">
              <label for="precioUnitario">
                Precio Unitario
                <span class="optional-badge">Opcional</span>
              </label>
              <div class="input-with-prefix">
                <span class="input-prefix">$</span>
                <input
                  type="number"
                  id="precioUnitario"
                  formControlName="precioUnitario"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  class="custom-input with-prefix"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="ubicacionAlmacen">
              Ubicación en Almacén
              <span class="optional-badge">Opcional</span>
            </label>
            <div class="input-with-icon">
              <i class="pi pi-map-marker input-icon"></i>
              <input
                type="text"
                id="ubicacionAlmacen"
                formControlName="ubicacionAlmacen"
                placeholder="Ej: Estante A, Nivel 3"
                class="custom-input with-icon"
              />
            </div>
            <span class="field-hint">
              Especifique la ubicación física para facilitar la búsqueda
            </span>
          </div>
        </div>
      </section>

      <!-- Resumen antes de guardar -->
      <section class="section-card summary-card" *ngIf="consumibleForm.valid">
        <div class="section-card-header">
          <div class="section-icon success">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="section-title">
            <h3>Resumen del Artículo</h3>
            <p>Verifique la información antes de guardar</p>
          </div>
        </div>
        <div class="section-card-body">
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Nombre</span>
              <span class="summary-value">{{
                consumibleForm.get("nombre")?.value
              }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Categoría</span>
              <span class="summary-value">{{
                consumibleForm.get("categoria")?.value
              }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Stock Inicial</span>
              <span class="summary-value">
                {{ consumibleForm.get("stockActual")?.value }}
                {{ consumibleForm.get("unidadMedida")?.value }}s
              </span>
            </div>
            <div
              class="summary-item"
              *ngIf="consumibleForm.get('precioUnitario')?.value"
            >
              <span class="summary-label">Precio</span>
              <span class="summary-value"
                >${{
                  consumibleForm.get("precioUnitario")?.value | number: "1.2-2"
                }}</span
              >
            </div>
          </div>
        </div>
      </section>

      <!-- Botones de acción -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancelar()">
          <i class="pi pi-times"></i>
          Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-accent"
          [disabled]="loading || consumibleForm.invalid"
          [class.loading]="loading"
        >
          <i
            class="pi"
            [ngClass]="loading ? 'pi-spin pi-spinner' : 'pi-save'"
          ></i>
          {{ loading ? "Guardando..." : "Guardar Artículo" }}
        </button>
      </div>
    </form>
  </div>
</div>

<app-navbar></app-navbar>

<div class="consumible-container">
  <div class="form-wrapper">
    <!-- Header Compacto -->
    <header class="page-header">
      <div class="header-content">
        <button class="btn-back" (click)="cancelar()" aria-label="Volver">
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <h1>
            <i class="pi pi-plus-circle"></i>
            Agregar {{ tituloTipo }}
          </h1>
        </div>
        <div class="header-badge" [ngClass]="'badge-' + tipoInventario">
          <i class="pi" [ngClass]="iconoTipo"></i>
          <span>{{ tipoInventario | titlecase }}</span>
        </div>
        <!-- Progress dots -->
        <div class="header-progress">
          <span
            class="progress-dot"
            [class.completed]="consumibleForm.get('nombre')?.valid"
          ></span>
          <span
            class="progress-dot"
            [class.completed]="consumibleForm.get('stockActual')?.valid"
          ></span>
          <span
            class="progress-dot"
            [class.completed]="consumibleForm.get('proveedor')?.value"
          ></span>
        </div>
      </div>
    </header>

    <form
      [formGroup]="consumibleForm"
      (ngSubmit)="onSubmit()"
      class="form-content"
    >
      <div class="form-grid-main">
        <!-- COLUMNA IZQUIERDA -->
        <div class="form-column">
          <!-- Información Básica -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-info-circle section-icon-sm"></i>
              <h3>Información Básica</h3>
            </div>

            <div class="form-group-compact">
              <label for="nombre">Nombre <span class="required">*</span></label>
              <input
                type="text"
                id="nombre"
                formControlName="nombre"
                [placeholder]="
                  tipoInventario === 'aseo'
                    ? 'Ej: Jabón líquido'
                    : 'Ej: Resmas de papel'
                "
                class="input-compact"
                [class.invalid]="isFieldInvalid('nombre')"
              />
              <span class="error-message" *ngIf="isFieldInvalid('nombre')">
                <i class="pi pi-exclamation-circle"></i>
                {{ getFieldError("nombre") }}
              </span>
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label for="categoria"
                  >Categoría <span class="required">*</span></label
                >
                <div class="select-wrapper">
                  <select
                    id="categoria"
                    formControlName="categoria"
                    class="select-compact"
                    [class.invalid]="isFieldInvalid('categoria')"
                  >
                    <option value="" disabled>Seleccione...</option>
                    <option *ngFor="let cat of categorias" [value]="cat">
                      {{ cat }}
                    </option>
                  </select>
                  <i class="pi pi-chevron-down"></i>
                </div>
              </div>

              <div class="form-group-compact">
                <label for="unidadMedida"
                  >Unidad <span class="required">*</span></label
                >
                <div class="select-wrapper">
                  <select
                    id="unidadMedida"
                    formControlName="unidadMedida"
                    class="select-compact"
                  >
                    <option
                      *ngFor="let unidad of unidadesMedida"
                      [value]="unidad.value"
                    >
                      {{ unidad.label }}
                    </option>
                  </select>
                  <i class="pi pi-chevron-down"></i>
                </div>
              </div>
            </div>

            <div class="form-group-compact">
              <label for="descripcion"
                >Descripción <span class="optional">Opcional</span></label
              >
              <textarea
                id="descripcion"
                formControlName="descripcion"
                rows="2"
                placeholder="Detalles adicionales..."
                class="textarea-compact"
                maxlength="500"
              ></textarea>
              <span
                class="char-count"
                *ngIf="consumibleForm.get('descripcion')?.value"
              >
                {{ consumibleForm.get("descripcion")?.value?.length || 0 }}/500
              </span>
            </div>
          </section>

          <!-- Control de Inventario -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-box section-icon-sm"></i>
              <h3>Control de Inventario</h3>
            </div>

            <div class="form-row-compact three-cols">
              <div class="form-group-compact">
                <label for="stockActual"
                  >Stock Actual <span class="required">*</span></label
                >
                <input
                  type="number"
                  id="stockActual"
                  formControlName="stockActual"
                  min="0"
                  placeholder="0"
                  class="input-compact"
                  [class.invalid]="isFieldInvalid('stockActual')"
                />
              </div>

              <div class="form-group-compact">
                <label for="stockMinimo"
                  >Mínimo <span class="required">*</span></label
                >
                <input
                  type="number"
                  id="stockMinimo"
                  formControlName="stockMinimo"
                  min="0"
                  placeholder="5"
                  class="input-compact"
                  [class.invalid]="isFieldInvalid('stockMinimo')"
                />
              </div>

              <div class="form-group-compact">
                <label for="stockMaximo">Máximo</label>
                <input
                  type="number"
                  id="stockMaximo"
                  formControlName="stockMaximo"
                  min="0"
                  placeholder="100"
                  class="input-compact"
                />
              </div>
            </div>

            <!-- Preview visual del stock -->
            <div
              class="stock-preview"
              *ngIf="consumibleForm.get('stockActual')?.value !== null"
            >
              <div class="stock-bar">
                <div
                  class="stock-bar-fill"
                  [style.width.%]="getStockPercentage()"
                  [class.low]="isStockLow()"
                  [class.ok]="!isStockLow()"
                ></div>
                <div
                  class="stock-min-marker"
                  [style.left.%]="getStockMinPercentage()"
                  *ngIf="consumibleForm.get('stockMinimo')?.value"
                ></div>
              </div>
              <div class="stock-labels">
                <span class="stock-value" [class.warning]="isStockLow()">
                  {{ consumibleForm.get("stockActual")?.value || 0 }}
                  {{ consumibleForm.get("unidadMedida")?.value }}
                </span>
                <span
                  class="stock-status"
                  [class.low]="isStockLow()"
                  [class.ok]="!isStockLow()"
                >
                  {{ isStockLow() ? "Stock bajo" : "Stock OK" }}
                </span>
              </div>
            </div>

            <div class="stock-tip">
              <i class="pi pi-lightbulb"></i>
              <span
                >Se alertará cuando el stock sea ≤ al mínimo configurado</span
              >
            </div>
          </section>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="form-column">
          <!-- Proveedor y Precio -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-truck section-icon-sm"></i>
              <h3>Proveedor y Compra</h3>
            </div>

            <div class="form-group-compact">
              <label for="proveedor">Proveedor</label>
              <input
                type="text"
                id="proveedor"
                formControlName="proveedor"
                placeholder="Nombre del proveedor"
                class="input-compact"
              />
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label for="precioUnitario">Precio Unitario</label>
                <div class="input-prefix-wrapper">
                  <span class="input-prefix">$</span>
                  <input
                    type="number"
                    id="precioUnitario"
                    formControlName="precioUnitario"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                    class="input-compact with-prefix"
                  />
                </div>
              </div>

              <div class="form-group-compact">
                <label for="ubicacionAlmacen">Ubicación</label>
                <input
                  type="text"
                  id="ubicacionAlmacen"
                  formControlName="ubicacionAlmacen"
                  placeholder="Estante A, Nivel 3"
                  class="input-compact"
                />
              </div>
            </div>
          </section>

          <!-- Resumen -->
          <section
            class="section-card section-compact summary-section"
            *ngIf="consumibleForm.valid"
          >
            <div class="section-header-inline">
              <i class="pi pi-check-circle section-icon-sm success"></i>
              <h3>Resumen</h3>
            </div>

            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">Artículo</span>
                <span class="summary-value">{{
                  consumibleForm.get("nombre")?.value
                }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Categoría</span>
                <span class="summary-value">{{
                  consumibleForm.get("categoria")?.value
                }}</span>
              </div>
              <div class="summary-item highlight">
                <span class="summary-label">Stock Inicial</span>
                <span class="summary-value">
                  {{ consumibleForm.get("stockActual")?.value }}
                  {{ consumibleForm.get("unidadMedida")?.value }}
                </span>
              </div>
              <div
                class="summary-item"
                *ngIf="consumibleForm.get('precioUnitario')?.value"
              >
                <span class="summary-label">Precio</span>
                <span class="summary-value"
                  >${{
                    consumibleForm.get("precioUnitario")?.value
                      | number: "1.2-2"
                  }}</span
                >
              </div>
            </div>

            <!-- Botones de acción integrados -->
            <div class="section-footer">
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-accent btn-compact"
                [disabled]="loading || consumibleForm.invalid"
                [class.loading]="loading"
              >
                <i
                  class="pi"
                  [ngClass]="loading ? 'pi-spin pi-spinner' : 'pi-save'"
                ></i>
                {{ loading ? "Guardando..." : "Guardar" }}
              </button>
            </div>
          </section>

          <!-- Si el formulario no es válido, mostrar botones aquí -->
          <section
            class="section-card section-compact actions-section"
            *ngIf="!consumibleForm.valid"
          >
            <div class="empty-summary">
              <i class="pi pi-info-circle"></i>
              <p>Complete los campos obligatorios para ver el resumen</p>
            </div>
            <div class="section-footer">
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-accent btn-compact" disabled>
                <i class="pi pi-save"></i> Guardar
              </button>
            </div>
          </section>
        </div>
      </div>
    </form>
  </div>
</div>

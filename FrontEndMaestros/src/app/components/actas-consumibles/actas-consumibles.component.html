<app-navbar></app-navbar>

<div class="actas-container" [class.aseo]="tipoInventario === 'aseo'" [class.papeleria]="tipoInventario === 'papeleria'">
  <div class="content-wrapper">
    <!-- Header -->
    <header class="page-header" [style.background]="'linear-gradient(135deg, ' + colorTema + ' 0%, ' + colorTema + 'cc 100%)'">
      <div class="header-content">
        <div class="header-info">
          <div class="header-badge">
            <i class="fas" [ngClass]="iconoTipo"></i>
            <span>Actas de Entrega</span>
          </div>
          <h1><i class="fas fa-file-alt"></i> Actas - {{ tituloTipo }}</h1>
          <p class="subtitle">
            Gestión de entregas de artículos con firma digital
          </p>
        </div>
        <div class="header-actions">
          <button class="btn btn-header" (click)="irACrearActa()">
            <i class="fas fa-plus"></i>
            Nueva Acta
          </button>
          <button class="btn btn-header-outline" (click)="irAInventario()">
            <i class="fas fa-boxes"></i>
            Ver Inventario
          </button>
        </div>
      </div>
    </header>

    <!-- Estadísticas -->
    <div class="stats-cards">
      <div class="stat-card" [class.active]="filtroEstado === 'todas'" (click)="filtroEstado = 'todas'; aplicarFiltros()">
        <div class="stat-icon all">
          <i class="fas fa-list"></i>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ actas.length }}</span>
          <span class="stat-label">Total Actas</span>
        </div>
      </div>

      <div class="stat-card" [class.active]="filtroEstado === 'pendiente_firma'" (click)="filtroEstado = 'pendiente_firma'; aplicarFiltros()">
        <div class="stat-icon pending">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ contarPendientesFirma() }}</span>
          <span class="stat-label">Pendientes</span>
        </div>
      </div>

      <div class="stat-card" [class.active]="filtroEstado === 'firmada'" (click)="filtroEstado = 'firmada'; aplicarFiltros()">
        <div class="stat-icon signed">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ contarFirmadas() }}</span>
          <span class="stat-label">Firmadas</span>
        </div>
      </div>

      <div class="stat-card" [class.active]="filtroEstado === 'rechazada'" (click)="filtroEstado = 'rechazada'; aplicarFiltros()">
        <div class="stat-icon rejected">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ contarRechazadas() }}</span>
          <span class="stat-label">Rechazadas</span>
        </div>
      </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="filters-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input
          type="text"
          [(ngModel)]="filtroBusqueda"
          (ngModelChange)="aplicarFiltros()"
          placeholder="Buscar por número de acta, receptor, área..."
        />
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Cargando actas...</p>
    </div>

    <!-- Error -->
    <div class="error-container" *ngIf="error && !loading">
      <div class="error-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p>{{ error }}</p>
      <button class="btn btn-retry" (click)="cargarActas()">
        <i class="fas fa-redo"></i> Reintentar
      </button>
    </div>

    <!-- Lista de actas -->
    <div class="actas-grid" *ngIf="!loading && !error">
      <!-- Sin resultados -->
      <div class="empty-state" *ngIf="actasFiltradas.length === 0">
        <div class="empty-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <h3>No hay actas</h3>
        <p *ngIf="actas.length === 0">Aún no se han creado actas de entrega para {{ tituloTipo }}</p>
        <p *ngIf="actas.length > 0">No se encontraron actas con los filtros seleccionados</p>
        <button class="btn btn-primary" (click)="irACrearActa()" *ngIf="actas.length === 0">
          <i class="fas fa-plus"></i> Crear Primera Acta
        </button>
      </div>

      <!-- Cards de actas -->
      <div
        class="acta-card"
        *ngFor="let acta of actasFiltradas"
        (click)="verDetalle(acta)"
        [class.selected]="actaSeleccionada?.id === acta.id"
      >
        <div class="acta-header">
          <span class="acta-numero">{{ acta.numeroActa }}</span>
          <span class="acta-estado" [ngClass]="getEstadoClass(acta.estado)">
            <i class="fas" [ngClass]="getEstadoIcon(acta.estado)"></i>
            {{ getEstadoLabel(acta.estado) }}
          </span>
        </div>

        <div class="acta-body">
          <div class="acta-receptor">
            <i class="fas fa-user"></i>
            <div class="receptor-info">
              <strong>{{ acta.nombreReceptor }}</strong>
              <span>{{ acta.cargoReceptor }}</span>
            </div>
          </div>

          <div class="acta-area" *ngIf="acta.areaReceptor">
            <i class="fas fa-building"></i>
            <span>{{ acta.areaReceptor }}</span>
          </div>

          <div class="acta-articulos">
            <i class="fas fa-boxes"></i>
            <span>{{ getTotalArticulos(acta) }} artículos ({{ acta.detalles?.length || 0 }} productos)</span>
          </div>
        </div>

        <div class="acta-footer">
          <span class="acta-fecha">
            <i class="fas fa-calendar"></i>
            {{ formatDate(acta.fechaEntrega) }}
          </span>
          <div class="acta-actions">
            <button
              class="btn-icon"
              *ngIf="acta.estado === 'pendiente_firma'"
              (click)="reenviarCorreo(acta); $event.stopPropagation()"
              [disabled]="reenviandoCorreo[acta.id!]"
              title="Reenviar correo"
            >
              <i class="fas" [ngClass]="reenviandoCorreo[acta.id!] ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
            </button>
            <button class="btn-icon" title="Ver detalle">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de detalle -->
  <div class="detalle-panel" [class.open]="actaSeleccionada !== null">
    <div class="detalle-overlay" (click)="cerrarDetalle()"></div>
    <div class="detalle-content" *ngIf="actaSeleccionada">
      <div class="detalle-header" [style.background]="'linear-gradient(135deg, ' + colorTema + ' 0%, ' + colorTema + 'cc 100%)'">
        <button class="btn-close" (click)="cerrarDetalle()">
          <i class="fas fa-times"></i>
        </button>
        <div class="detalle-titulo">
          <span class="acta-badge">{{ actaSeleccionada.numeroActa }}</span>
          <span class="estado-badge" [ngClass]="getEstadoClass(actaSeleccionada.estado)">
            <i class="fas" [ngClass]="getEstadoIcon(actaSeleccionada.estado)"></i>
            {{ getEstadoLabel(actaSeleccionada.estado) }}
          </span>
        </div>
      </div>

      <div class="detalle-body" *ngIf="!loadingDetalle">
        <!-- Receptor -->
        <div class="detalle-section">
          <h4><i class="fas fa-user"></i> Receptor</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Nombre</span>
              <span class="info-value">{{ actaSeleccionada.nombreReceptor }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Cargo</span>
              <span class="info-value">{{ actaSeleccionada.cargoReceptor }}</span>
            </div>
            <div class="info-item" *ngIf="actaSeleccionada.areaReceptor">
              <span class="info-label">Área</span>
              <span class="info-value">{{ actaSeleccionada.areaReceptor }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Correo</span>
              <span class="info-value email">{{ actaSeleccionada.correoReceptor }}</span>
            </div>
          </div>
        </div>

        <!-- Fechas -->
        <div class="detalle-section">
          <h4><i class="fas fa-calendar"></i> Fechas</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Fecha Entrega</span>
              <span class="info-value">{{ formatDate(actaSeleccionada.fechaEntrega) }}</span>
            </div>
            <div class="info-item" *ngIf="actaSeleccionada.fechaFirma">
              <span class="info-label">Fecha Firma</span>
              <span class="info-value">{{ formatDate(actaSeleccionada.fechaFirma) }}</span>
            </div>
          </div>
        </div>

        <!-- Artículos entregados -->
        <div class="detalle-section">
          <h4><i class="fas fa-boxes"></i> Artículos Entregados ({{ actaSeleccionada.detalles?.length || 0 }})</h4>
          <div class="articulos-lista">
            <div class="articulo-item" *ngFor="let detalle of actaSeleccionada.detalles">
              <div class="articulo-icon">
                <i class="fas" [ngClass]="getCategoriaIcon(detalle.consumible?.categoria)"></i>
              </div>
              <div class="articulo-info">
                <strong>{{ detalle.consumible?.nombre || 'Artículo' }}</strong>
                <span class="articulo-cantidad">
                  <i class="fas fa-cubes"></i> {{ detalle.cantidad }} {{ detalle.unidadMedida }}s
                </span>
                <span class="articulo-obs" *ngIf="detalle.observaciones">
                  {{ detalle.observaciones }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="detalle-section" *ngIf="actaSeleccionada.observaciones">
          <h4><i class="fas fa-comment"></i> Observaciones</h4>
          <p class="observaciones-text">{{ actaSeleccionada.observaciones }}</p>
        </div>

        <!-- Motivo de rechazo -->
        <div class="detalle-section rechazo" *ngIf="actaSeleccionada.estado === 'rechazada' && actaSeleccionada.motivoRechazo">
          <h4><i class="fas fa-ban"></i> Motivo de Rechazo</h4>
          <p class="rechazo-text">{{ actaSeleccionada.motivoRechazo }}</p>
        </div>

        <!-- Firma -->
        <div class="detalle-section firma" *ngIf="actaSeleccionada.estado === 'firmada' && actaSeleccionada.firmaReceptor">
          <h4><i class="fas fa-signature"></i> Firma del Receptor</h4>
          <div class="firma-preview">
            <img [src]="actaSeleccionada.firmaReceptor" alt="Firma del receptor" />
          </div>
        </div>
      </div>

      <!-- Loading detalle -->
      <div class="detalle-loading" *ngIf="loadingDetalle">
        <div class="spinner"></div>
        <p>Cargando detalle...</p>
      </div>

      <!-- Acciones -->
      <div class="detalle-actions" *ngIf="!loadingDetalle">
        <button
          class="btn btn-secondary"
          *ngIf="actaSeleccionada.estado === 'pendiente_firma'"
          (click)="reenviarCorreo(actaSeleccionada)"
          [disabled]="reenviandoCorreo[actaSeleccionada.id!]"
        >
          <i class="fas" [ngClass]="reenviandoCorreo[actaSeleccionada.id!] ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
          {{ reenviandoCorreo[actaSeleccionada.id!] ? 'Enviando...' : 'Reenviar Correo' }}
        </button>
      </div>
    </div>
  </div>
</div>

<app-navbar></app-navbar>

<div
  class="crear-acta-container"
  [class.aseo]="tipoInventario === 'aseo'"
  [class.papeleria]="tipoInventario === 'papeleria'"
>
  <div class="form-wrapper">
    <!-- Header Negro -->
    <header class="page-header">
      <div class="header-content">
        <button class="btn-back" (click)="cancelar()" aria-label="Volver">
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <h1>
            <i class="pi pi-file-edit"></i>
            Acta de Entrega - {{ tituloTipo }}
          </h1>
        </div>
        <div class="header-badge" [ngClass]="'badge-' + tipoInventario">
          <i class="pi" [ngClass]="iconoTipo"></i>
          <span>{{ tipoInventario | titlecase }}</span>
        </div>
        <div class="header-progress">
          <span
            class="progress-dot"
            [class.completed]="receptor.nombre && receptor.correo"
          ></span>
          <span
            class="progress-dot"
            [class.completed]="articulosSeleccionados.length > 0"
          ></span>
          <span
            class="progress-dot"
            [class.completed]="
              articulosSeleccionados.length > 0 && receptor.nombre
            "
          ></span>
        </div>
      </div>
    </header>

    <!-- Alertas -->
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="pi pi-exclamation-circle"></i>
      <span>{{ errorMessage }}</span>
      <button class="alert-close" (click)="errorMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="alert alert-success" *ngIf="successMessage">
      <i class="pi pi-check-circle"></i>
      <span>{{ successMessage }}</span>
      <button class="alert-close" (click)="successMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <form (ngSubmit)="crearActa()" class="form-content">
      <div class="form-grid-main">
        <!-- COLUMNA IZQUIERDA -->
        <div class="form-column">
          <!-- Datos del receptor -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-user section-icon-sm"></i>
              <h3>Datos del receptor</h3>
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label for="nombre"
                  >Nombre <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="nombre"
                  [(ngModel)]="receptor.nombre"
                  name="nombre"
                  placeholder="Nombre completo"
                  class="input-compact"
                  required
                />
              </div>
              <div class="form-group-compact">
                <label for="cargo">Cargo <span class="required">*</span></label>
                <input
                  type="text"
                  id="cargo"
                  [(ngModel)]="receptor.cargo"
                  name="cargo"
                  placeholder="Cargo o posición"
                  class="input-compact"
                  required
                />
              </div>
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label for="area">Área</label>
                <div class="select-wrapper">
                  <select
                    id="area"
                    [(ngModel)]="receptor.area"
                    name="area"
                    class="select-compact"
                  >
                    <option value="">Seleccione...</option>
                    <option *ngFor="let a of areas" [value]="a">{{ a }}</option>
                  </select>
                  <i class="pi pi-chevron-down"></i>
                </div>
              </div>
              <div class="form-group-compact">
                <label for="correo"
                  >Correo <span class="required">*</span></label
                >
                <input
                  type="email"
                  id="correo"
                  [(ngModel)]="receptor.correo"
                  name="correo"
                  placeholder="correo@ejemplo.com"
                  class="input-compact"
                  required
                />
              </div>
            </div>

            <div class="field-hint">
              <i class="pi pi-info-circle"></i>
              <span
                >El receptor recibirá un enlace para firmar digitalmente</span
              >
            </div>
          </section>

          <!-- Observaciones -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-comment section-icon-sm"></i>
              <h3>Observaciones</h3>
            </div>
            <textarea
              id="observaciones"
              [(ngModel)]="observacionesEntrega"
              name="observaciones"
              rows="3"
              placeholder="Notas adicionales sobre la entrega..."
              class="textarea-compact"
            ></textarea>
          </section>

        </div>

        <!-- COLUMNA DERECHA -->
        <div class="form-column column-articulos">
          <section class="section-card section-compact section-articulos">
            <div class="section-header-inline">
              <i class="pi pi-box section-icon-sm tipo"></i>
              <h3>Artículos a entregar</h3>
              <span
                class="badge-count"
                *ngIf="articulosSeleccionados.length > 0"
              >
                {{ getTotalArticulos() }}
              </span>
            </div>

            <!-- Disponibles -->
            <div class="disponibles-area">
              <label class="mini-label">Disponibles:</label>

              <!-- Buscador de artículos -->
              <div class="buscador-dispositivos">
                <i class="pi pi-search"></i>
                <input
                  type="text"
                  [(ngModel)]="busquedaArticulo"
                  (input)="filtrarArticulos()"
                  placeholder="Buscar por nombre, categoría..."
                  class="input-busqueda"
                  name="busquedaArticulo"
                />
                <button
                  type="button"
                  class="btn-limpiar-busqueda"
                  *ngIf="busquedaArticulo"
                  (click)="busquedaArticulo = ''; filtrarArticulos()"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>

              <div class="loading-inline" *ngIf="loadingArticulos">
                <div class="spinner-sm"></div>
                <span>Cargando...</span>
              </div>

              <div
                class="disponibles-scroll"
                *ngIf="!loadingArticulos && articulosFiltrados.length > 0"
              >
                <div
                  class="art-chip"
                  *ngFor="let art of articulosFiltrados"
                  (click)="agregarArticulo(art)"
                  tabindex="0"
                >
                  <i class="pi" [ngClass]="getCategoriaIcon(art.categoria)"></i>
                  <div class="art-chip-info">
                    <span class="art-chip-name">{{ art.nombre }}</span>
                    <span class="art-chip-stock"
                      >{{ art.stockActual }} disp.</span
                    >
                  </div>
                  <i class="pi pi-plus add-icon"></i>
                </div>
              </div>

              <div
                class="empty-mini"
                *ngIf="!loadingArticulos && articulosFiltrados.length === 0 && busquedaArticulo"
              >
                <i class="pi pi-search"></i>
                <span>No se encontraron artículos con "{{ busquedaArticulo }}"</span>
              </div>

              <div
                class="empty-mini"
                *ngIf="!loadingArticulos && articulosDisponibles.length === 0 && !busquedaArticulo"
              >
                <i class="pi pi-inbox"></i>
                <span>No hay artículos disponibles</span>
              </div>
            </div>

            <!-- Seleccionados -->
            <div
              class="seleccionados-area"
              *ngIf="articulosSeleccionados.length > 0"
            >
              <label class="mini-label success">
                <i class="pi pi-check-circle"></i>
                Seleccionados ({{ articulosSeleccionados.length }}):
              </label>

              <div class="seleccionados-list">
                <div
                  class="art-card"
                  *ngFor="let item of articulosSeleccionados; let i = index"
                >
                  <div class="art-card-header">
                    <div class="art-card-icon">
                      <i
                        class="pi"
                        [ngClass]="getCategoriaIcon(item.consumible.categoria)"
                      ></i>
                    </div>
                    <div class="art-card-title">
                      <h4>{{ item.consumible.nombre }}</h4>
                      <span>{{
                        item.consumible.categoria || "Sin categoría"
                      }}</span>
                    </div>
                    <button
                      type="button"
                      class="btn-remove-card"
                      (click)="quitarArticulo(i)"
                    >
                      <i class="pi pi-times"></i>
                    </button>
                  </div>

                  <div class="art-card-form">
                    <div class="cantidad-row">
                      <label>Cantidad:</label>
                      <div class="cantidad-control">
                        <button
                          type="button"
                          class="btn-qty"
                          (click)="
                            item.cantidad =
                              item.cantidad > 1 ? item.cantidad - 1 : 1
                          "
                        >
                          <i class="pi pi-minus"></i>
                        </button>
                        <input
                          type="number"
                          [(ngModel)]="item.cantidad"
                          [name]="'cant_' + i"
                          min="1"
                          [max]="item.consumible.stockActual"
                          (change)="validarCantidad(i)"
                          class="input-qty"
                        />
                        <button
                          type="button"
                          class="btn-qty"
                          (click)="
                            item.cantidad =
                              item.cantidad < item.consumible.stockActual
                                ? item.cantidad + 1
                                : item.consumible.stockActual
                          "
                        >
                          <i class="pi pi-plus"></i>
                        </button>
                      </div>
                      <span class="stock-info"
                        >de {{ item.consumible.stockActual }}
                        {{ item.consumible.unidadMedida }}</span
                      >
                    </div>

                    <div class="form-field">
                      <label>Observaciones:</label>
                      <input
                        type="text"
                        [(ngModel)]="item.observaciones"
                        [name]="'obs_' + i"
                        placeholder="Opcional..."
                        class="input-mini"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sin seleccionados -->
            <div
              class="empty-seleccionados"
              *ngIf="articulosSeleccionados.length === 0"
            >
              <i class="pi pi-arrow-up"></i>
              <p>Selecciona artículos de la lista superior</p>
            </div>

            <!-- Resumen + Botones -->
            <div
              class="section-footer-summary"
              *ngIf="articulosSeleccionados.length > 0"
            >
              <div class="summary-mini">
                <div class="summary-row">
                  <span>Receptor:</span>
                  <strong>{{ receptor.nombre || "-" }}</strong>
                </div>
                <div class="summary-row">
                  <span>Área:</span>
                  <strong>{{ receptor.area || "-" }}</strong>
                </div>
                <div class="summary-row highlight">
                  <span>Total:</span>
                  <strong
                    >{{ getTotalArticulos() }} unidades ({{
                      articulosSeleccionados.length
                    }}
                    productos)</strong
                  >
                </div>
              </div>

              <div class="section-footer">
                <button
                  type="button"
                  class="btn btn-secondary btn-compact"
                  (click)="cancelar()"
                >
                  <i class="pi pi-times"></i> Cancelar
                </button>
                <button
                  type="submit"
                  class="btn btn-accent btn-compact"
                  [disabled]="
                    loading ||
                    enviandoCorreo ||
                    articulosSeleccionados.length === 0 ||
                    !receptor.nombre ||
                    !receptor.correo
                  "
                  [class.loading]="loading || enviandoCorreo"
                >
                  <i
                    class="pi"
                    [ngClass]="
                      loading || enviandoCorreo
                        ? 'pi-spin pi-spinner'
                        : 'pi-send'
                    "
                  ></i>
                  {{
                    loading
                      ? "Creando..."
                      : enviandoCorreo
                        ? "Enviando..."
                        : "Crear y Enviar"
                  }}
                </button>
              </div>
            </div>

            <!-- Sin artículos -->
            <div
              class="section-footer"
              *ngIf="articulosSeleccionados.length === 0"
            >
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-accent btn-compact" disabled>
                <i class="pi pi-send"></i> Crear y Enviar
              </button>
            </div>
          </section>
        </div>
      </div>
    </form>
  </div>
</div>

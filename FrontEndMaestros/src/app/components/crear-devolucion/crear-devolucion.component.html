<app-navbar></app-navbar>

<div class="crear-devolucion-container">
  <div class="form-wrapper">
    <!-- Header Compacto -->
    <header class="page-header">
      <div class="header-content">
        <button class="btn-back" (click)="cancelar()" aria-label="Volver">
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <h1><i class="pi pi-replay"></i> Nueva Acta de Devolución</h1>
        </div>
        <div class="header-steps">
          <span
            class="step"
            [class.completed]="entrega.nombre && entrega.correo"
          >
            <i class="pi pi-user"></i>
          </span>
          <span class="step" [class.completed]="receptor.nombre">
            <i class="pi pi-user-plus"></i>
          </span>
          <span
            class="step"
            [class.completed]="dispositivosSeleccionados.length > 0"
          >
            <i class="pi pi-mobile"></i>
          </span>
          <span class="step" [class.completed]="firmaReceptorData">
            <i class="pi pi-pencil"></i>
          </span>
        </div>
      </div>
    </header>

    <!-- Alertas -->
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="pi pi-exclamation-circle"></i>
      <span>{{ errorMessage }}</span>
      <button class="alert-close" (click)="errorMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="alert alert-success" *ngIf="successMessage && !actaCreada">
      <i class="pi pi-check-circle"></i>
      <span>{{ successMessage }}</span>
      <button class="alert-close" (click)="successMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Formulario Principal -->
    <div class="form-content" *ngIf="!actaCreada">
      <div class="form-grid-main">
        <!-- COLUMNA IZQUIERDA -->
        <div class="form-column">
          <!-- Quien Devuelve -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-user section-icon-sm devuelve"></i>
              <h3>Quien Devuelve</h3>
            </div>

            <div class="form-group-compact">
              <label>Nombre <span class="required">*</span></label>
              <input
                type="text"
                [(ngModel)]="entrega.nombre"
                placeholder="Nombre del empleado"
                class="input-compact"
              />
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label>Cargo <span class="required">*</span></label>
                <input
                  type="text"
                  [(ngModel)]="entrega.cargo"
                  placeholder="Cargo"
                  class="input-compact"
                />
              </div>
              <div class="form-group-compact">
                <label>Correo <span class="required">*</span></label>
                <input
                  type="email"
                  [(ngModel)]="entrega.correo"
                  placeholder="correo@ejemplo.com"
                  class="input-compact"
                />
              </div>
            </div>

            <div class="field-hint">
              <i class="pi pi-info-circle"></i>
              <span>Se enviará un enlace para firmar digitalmente</span>
            </div>
          </section>

          <!-- Quien Recibe -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-user-plus section-icon-sm recibe"></i>
              <h3>Quien Recibe (Sistemas)</h3>
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label>Nombre <span class="required">*</span></label>
                <input
                  type="text"
                  [(ngModel)]="receptor.nombre"
                  placeholder="Nombre"
                  class="input-compact"
                />
              </div>
              <div class="form-group-compact">
                <label>Cargo</label>
                <input
                  type="text"
                  [(ngModel)]="receptor.cargo"
                  placeholder="Cargo"
                  class="input-compact"
                />
              </div>
            </div>

            <div class="form-group-compact">
              <label>Correo (opcional)</label>
              <input
                type="email"
                [(ngModel)]="receptor.correo"
                placeholder="Para enviar copia"
                class="input-compact"
              />
            </div>

            <!-- Firma del receptor -->
            <div class="firma-section">
              <label class="firma-label">
                <i class="pi pi-pencil"></i>
                Firma de quien recibe <span class="required">*</span>
              </label>
              <div class="signature-wrapper">
                <canvas
                  #signatureCanvasReceptor
                  class="signature-canvas"
                ></canvas>
                <button
                  type="button"
                  class="btn-limpiar-firma"
                  (click)="limpiarFirmaReceptor()"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </div>
          </section>

          <!-- Observaciones -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-comment section-icon-sm"></i>
              <h3>Observaciones</h3>
            </div>
            <textarea
              [(ngModel)]="observaciones"
              rows="3"
              placeholder="Observaciones generales sobre la devolución..."
              class="textarea-compact"
            ></textarea>
          </section>
        </div>

        <!-- COLUMNA DERECHA - Dispositivos -->
        <div class="form-column column-devices">
          <section class="section-card section-compact section-devices">
            <div class="section-header-inline">
              <i class="pi pi-mobile section-icon-sm"></i>
              <h3>Dispositivos a Devolver</h3>
              <span
                class="badge-count"
                *ngIf="dispositivosSeleccionados.length > 0"
              >
                {{ dispositivosSeleccionados.length }}
              </span>
            </div>

            <!-- Disponibles -->
            <div class="disponibles-area">
              <label class="mini-label">Dispositivos entregados:</label>

              <!-- Buscador de dispositivos -->
              <div class="buscador-dispositivos">
                <i class="pi pi-search"></i>
                <input
                  type="text"
                  [(ngModel)]="busquedaDispositivo"
                  (input)="filtrarDispositivos()"
                  placeholder="Buscar por nombre, marca, modelo, serial, IMEI o receptor..."
                  class="input-busqueda"
                  name="busquedaDispositivo"
                />
                <button
                  type="button"
                  class="btn-limpiar-busqueda"
                  *ngIf="busquedaDispositivo"
                  (click)="busquedaDispositivo = ''; filtrarDispositivos()"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>

              <div class="loading-inline" *ngIf="loadingDispositivos">
                <div class="spinner-sm"></div>
                <span>Cargando dispositivos...</span>
              </div>

              <div
                class="disponibles-scroll"
                *ngIf="
                  !loadingDispositivos &&
                  dispositivosEntregadosFiltrados.length > 0
                "
              >
                <div
                  class="disp-chip"
                  *ngFor="let disp of dispositivosEntregadosFiltrados"
                  (click)="agregarDispositivo(disp)"
                  [title]="'Clic para agregar: ' + disp.nombre"
                >
                  <div class="disp-chip-icon-wrapper">
                    <i
                      class="pi"
                      [ngClass]="getCategoriaIcon(disp.categoria)"
                    ></i>
                  </div>
                  <div class="disp-chip-info">
                    <span class="disp-chip-name">{{ disp.nombre }}</span>
                    <span class="disp-chip-detail">
                      {{ disp.marca }}
                      <span *ngIf="disp.modelo"> — {{ disp.modelo }}</span>
                    </span>
                    <span
                      class="disp-chip-serial"
                      *ngIf="disp.imei || disp.serial"
                    >
                      <i class="pi pi-hashtag"></i>
                      {{
                        disp.imei ? "IMEI: " + disp.imei : "S/N: " + disp.serial
                      }}
                    </span>
                  </div>
                  <span class="disp-chip-receptor" *ngIf="disp.receptor">
                    <i class="pi pi-user"></i> {{ disp.receptor }}
                  </span>
                  <div class="disp-chip-add">
                    <i class="pi pi-plus"></i>
                  </div>
                </div>
              </div>

              <!-- Sin resultados de búsqueda -->
              <div
                class="empty-mini"
                *ngIf="
                  !loadingDispositivos &&
                  dispositivosEntregadosFiltrados.length === 0 &&
                  busquedaDispositivo
                "
              >
                <i class="pi pi-search"></i>
                <span
                  >No se encontraron dispositivos con "<strong>{{
                    busquedaDispositivo
                  }}</strong
                  >"</span
                >
              </div>

              <div
                class="empty-mini"
                *ngIf="
                  !loadingDispositivos &&
                  dispositivosEntregados.length === 0 &&
                  !busquedaDispositivo
                "
              >
                <i class="pi pi-inbox"></i>
                <span>No hay dispositivos para devolver</span>
              </div>
            </div>

            <!-- Seleccionados -->
            <div
              class="seleccionados-area"
              *ngIf="dispositivosSeleccionados.length > 0"
            >
              <label class="mini-label success">
                <i class="pi pi-check-circle"></i>
                Seleccionados ({{ dispositivosSeleccionados.length }}):
              </label>

              <div class="seleccionados-list">
                <div
                  class="disp-card"
                  *ngFor="let item of dispositivosSeleccionados; let i = index"
                >
                  <div class="disp-card-header">
                    <div class="disp-card-icon">
                      <i
                        class="pi"
                        [ngClass]="getCategoriaIcon(item.dispositivo.categoria)"
                      ></i>
                    </div>
                    <div class="disp-card-title">
                      <h4>{{ item.dispositivo.nombre }}</h4>
                      <span
                        >{{ item.dispositivo.marca }}
                        {{ item.dispositivo.modelo }}</span
                      >
                    </div>
                    <button
                      type="button"
                      class="btn-remove-card"
                      (click)="quitarDispositivo(i)"
                    >
                      <i class="pi pi-times"></i>
                    </button>
                  </div>

                  <div
                    class="disp-card-identifiers"
                    *ngIf="item.dispositivo.imei || item.dispositivo.serial"
                  >
                    <div class="identifier" *ngIf="item.dispositivo.imei">
                      <i class="pi pi-mobile"></i>
                      <span>IMEI: {{ item.dispositivo.imei }}</span>
                    </div>
                    <div class="identifier" *ngIf="item.dispositivo.serial">
                      <i class="pi pi-hashtag"></i>
                      <span>S/N: {{ item.dispositivo.serial }}</span>
                    </div>
                  </div>

                  <div class="disp-card-form">
                    <div class="form-row-device">
                      <div class="form-field">
                        <label>Estado devolución</label>
                        <div class="select-device">
                          <select [(ngModel)]="item.estadoDevolucion">
                            <option
                              *ngFor="let estado of estadosDevolucion"
                              [value]="estado.value"
                            >
                              {{ estado.label }}
                            </option>
                          </select>
                          <i class="pi pi-chevron-down"></i>
                        </div>
                      </div>
                      <div class="form-field">
                        <label>Condición</label>
                        <div class="select-device">
                          <select [(ngModel)]="item.condicion">
                            <option
                              *ngFor="let cond of condiciones"
                              [value]="cond.value"
                            >
                              {{ cond.label }}
                            </option>
                          </select>
                          <i class="pi pi-chevron-down"></i>
                        </div>
                      </div>
                    </div>

                    <div class="form-field">
                      <label>Observaciones</label>
                      <input
                        type="text"
                        [(ngModel)]="item.observaciones"
                        placeholder="Daños, accesorios..."
                        class="input-device"
                      />
                    </div>

                    <div class="fotos-section">
                      <label class="fotos-upload-btn" [for]="'fotos_' + i">
                        <i class="pi pi-camera"></i>
                        <span>Agregar fotos</span>
                        <input
                          type="file"
                          [id]="'fotos_' + i"
                          accept="image/*"
                          multiple
                          (change)="onFotosSelected($event, i)"
                          hidden
                        />
                      </label>
                      <div
                        class="fotos-preview-grid"
                        *ngIf="item.fotosPreview.length > 0"
                      >
                        <div
                          class="foto-preview-item"
                          *ngFor="
                            let preview of item.fotosPreview;
                            let j = index
                          "
                        >
                          <img [src]="preview" alt="Foto" />
                          <button
                            type="button"
                            class="foto-delete"
                            (click)="eliminarFoto(i, j)"
                          >
                            <i class="pi pi-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mensaje cuando no hay seleccionados -->
            <div
              class="empty-seleccionados"
              *ngIf="dispositivosSeleccionados.length === 0"
            >
              <i class="pi pi-arrow-up"></i>
              <p>Selecciona dispositivos de la lista superior</p>
            </div>

            <!-- Botones de acción -->
            <div class="section-footer">
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button
                type="button"
                class="btn btn-accent btn-compact"
                (click)="crearActaDevolucion()"
                [disabled]="
                  loading ||
                  enviandoCorreo ||
                  dispositivosSeleccionados.length === 0
                "
                [class.loading]="loading || enviandoCorreo"
              >
                <i
                  class="pi"
                  [ngClass]="
                    loading || enviandoCorreo ? 'pi-spin pi-spinner' : 'pi-send'
                  "
                ></i>
                {{
                  loading
                    ? "Creando..."
                    : enviandoCorreo
                      ? "Enviando..."
                      : "Crear y Enviar"
                }}
              </button>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Mensaje de éxito después de crear -->
    <div class="success-container" *ngIf="actaCreada && successMessage">
      <div class="success-card">
        <div class="success-icon">
          <i class="pi pi-check-circle"></i>
        </div>
        <h2>¡Acta Creada Exitosamente!</h2>
        <p>{{ successMessage }}</p>
        <div class="redirect-info">
          <div class="spinner-sm"></div>
          <span>Redirigiendo en 3 segundos...</span>
        </div>
      </div>
    </div>
  </div>
</div>

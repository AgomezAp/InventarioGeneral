<app-navbar></app-navbar>

<div class="crear-acta-container">
  <div class="form-wrapper">
    <!-- Header Compacto -->
    <header class="page-header">
      <div class="header-content">
        <button class="btn-back" (click)="cancelar()" aria-label="Volver">
          <i class="pi pi-arrow-left"></i>
        </button>
        <div class="header-info">
          <h1><i class="pi pi-file-edit"></i> Crear Acta de Entrega</h1>
        </div>
        <!-- Indicador de pasos -->
        <div class="header-steps">
          <span
            class="step"
            [class.completed]="receptor.nombre && receptor.correo"
          >
            <i class="pi pi-user"></i>
          </span>
          <span
            class="step"
            [class.completed]="dispositivosSeleccionados.length > 0"
          >
            <i class="pi pi-box"></i>
          </span>
          <span
            class="step"
            [class.completed]="
              dispositivosSeleccionados.length > 0 && receptor.nombre
            "
          >
            <i class="pi pi-send"></i>
          </span>
        </div>
      </div>
    </header>

    <!-- Alertas -->
    <div class="alert alert-error" *ngIf="errorMessage">
      <i class="pi pi-exclamation-circle"></i>
      <span>{{ errorMessage }}</span>
      <button class="alert-close" (click)="errorMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="alert alert-success" *ngIf="successMessage">
      <i class="pi pi-check-circle"></i>
      <span>{{ successMessage }}</span>
      <button class="alert-close" (click)="successMessage = ''">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <form (ngSubmit)="crearActa()" class="form-content">
      <!-- Layout de 2 columnas -->
      <div class="form-grid-main">
        <!-- COLUMNA IZQUIERDA -->
        <div class="form-column">
          <!-- Datos del receptor - Compacto -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-user section-icon-sm"></i>
              <h3>Datos del receptor</h3>
            </div>

            <div class="form-row-compact">
              <div class="form-group-compact">
                <label for="nombre"
                  >Nombre <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="nombre"
                  [(ngModel)]="receptor.nombre"
                  name="nombre"
                  placeholder="Nombre completo"
                  class="input-compact"
                  required
                />
              </div>
              <div class="form-group-compact">
                <label for="cargo">Cargo <span class="required">*</span></label>
                <input
                  type="text"
                  id="cargo"
                  [(ngModel)]="receptor.cargo"
                  name="cargo"
                  placeholder="Cargo o posición"
                  class="input-compact"
                  required
                />
              </div>
            </div>

            <div class="form-group-compact">
              <label for="correo">Correo <span class="required">*</span></label>
              <div class="input-icon-wrapper">
                <i class="pi pi-envelope"></i>
                <input
                  type="email"
                  id="correo"
                  [(ngModel)]="receptor.correo"
                  name="correo"
                  placeholder="correo@ejemplo.com"
                  class="input-compact with-icon"
                  required
                />
              </div>
              <span class="field-hint">
                <i class="pi pi-info-circle"></i>
                El receptor recibirá un enlace para firmar digitalmente
              </span>
            </div>
          </section>

          <!-- Dispositivos a entregar -->
          <section class="section-card section-compact section-devices">
            <div class="section-header-inline">
              <i class="pi pi-box section-icon-sm"></i>
              <h3>Dispositivos a entregar</h3>
              <span
                class="badge-count"
                *ngIf="dispositivosSeleccionados.length > 0"
              >
                {{ dispositivosSeleccionados.length }}
              </span>
            </div>

            <!-- Dispositivos disponibles -->
            <div class="disponibles-area">
              <label class="mini-label">Disponibles:</label>

              <!-- Loading -->
              <div class="loading-inline" *ngIf="loadingDispositivos">
                <div class="spinner-sm"></div>
                <span>Cargando...</span>
              </div>

              <!-- Lista compacta de disponibles -->
              <div
                class="disponibles-scroll"
                *ngIf="
                  !loadingDispositivos && dispositivosDisponibles.length > 0
                "
              >
                <div
                  class="disp-chip"
                  *ngFor="let disp of dispositivosDisponibles"
                  (click)="agregarDispositivo(disp)"
                  tabindex="0"
                >
                  <i
                    class="pi"
                    [ngClass]="getCategoriaIcon(disp.categoria)"
                  ></i>
                  <span class="disp-chip-name">{{ disp.nombre }}</span>
                  <span class="disp-chip-detail" *ngIf="disp.marca">{{
                    disp.marca
                  }}</span>
                  <i class="pi pi-plus add-icon"></i>
                </div>
              </div>

              <!-- Sin disponibles -->
              <div
                class="empty-mini"
                *ngIf="
                  !loadingDispositivos && dispositivosDisponibles.length === 0
                "
              >
                <i class="pi pi-inbox"></i>
                <span>No hay dispositivos disponibles</span>
              </div>
            </div>

            <!-- Dispositivos seleccionados - EXPANDIDO -->
            <div
              class="seleccionados-area"
              *ngIf="dispositivosSeleccionados.length > 0"
            >
              <label class="mini-label success">
                <i class="pi pi-check-circle"></i>
                Seleccionados ({{ dispositivosSeleccionados.length }}):
              </label>

              <!-- Contenedor con scroll solo si hay más de 3 -->
              <div
                class="seleccionados-list"
                [class.with-scroll]="dispositivosSeleccionados.length > 3"
              >
                <div
                  class="disp-card"
                  *ngFor="let item of dispositivosSeleccionados; let i = index"
                >
                  <!-- Header del dispositivo -->
                  <div class="disp-card-header">
                    <div class="disp-card-icon">
                      <i
                        class="pi"
                        [ngClass]="getCategoriaIcon(item.dispositivo.categoria)"
                      ></i>
                    </div>
                    <div class="disp-card-title">
                      <h4>{{ item.dispositivo.nombre }}</h4>
                      <span class="disp-card-subtitle">
                        {{ item.dispositivo.marca }}
                        {{ item.dispositivo.modelo }}
                      </span>
                    </div>
                    <button
                      type="button"
                      class="btn-remove-card"
                      (click)="quitarDispositivo(i)"
                      title="Quitar dispositivo"
                    >
                      <i class="pi pi-times"></i>
                    </button>
                  </div>

                  <!-- Identificadores -->
                  <div
                    class="disp-card-identifiers"
                    *ngIf="item.dispositivo.imei || item.dispositivo.serial"
                  >
                    <div class="identifier" *ngIf="item.dispositivo.imei">
                      <i class="pi pi-mobile"></i>
                      <span class="identifier-label">IMEI:</span>
                      <span class="identifier-value">{{
                        item.dispositivo.imei
                      }}</span>
                    </div>
                    <div class="identifier" *ngIf="item.dispositivo.serial">
                      <i class="pi pi-hashtag"></i>
                      <span class="identifier-label">Serial:</span>
                      <span class="identifier-value">{{
                        item.dispositivo.serial
                      }}</span>
                    </div>
                  </div>

                  <!-- Formulario del dispositivo -->
                  <div class="disp-card-form">
                    <div class="form-row-device">
                      <div class="form-field">
                        <label>Condición al entregar</label>
                        <div class="select-device">
                          <select
                            [(ngModel)]="item.condicion"
                            [name]="'condicion_' + i"
                          >
                            <option
                              *ngFor="let cond of condiciones"
                              [value]="cond.value"
                            >
                              {{ cond.label }}
                            </option>
                          </select>
                          <i class="pi pi-chevron-down"></i>
                        </div>
                      </div>
                      <div class="form-field flex-grow">
                        <label>Observaciones</label>
                        <input
                          type="text"
                          [(ngModel)]="item.observaciones"
                          [name]="'obs_' + i"
                          placeholder="Daños, accesorios incluidos, notas..."
                          class="input-device"
                        />
                      </div>
                    </div>

                    <!-- Fotos del dispositivo -->
                    <div class="fotos-section">
                      <label class="fotos-upload-btn" [for]="'fotos_' + i">
                        <i class="pi pi-camera"></i>
                        <span>Agregar fotos del estado actual</span>
                        <input
                          type="file"
                          [id]="'fotos_' + i"
                          multiple
                          accept="image/*"
                          (change)="onFotosSelected($event, i)"
                          hidden
                        />
                      </label>

                      <div
                        class="fotos-preview-grid"
                        *ngIf="item.fotosPreview.length > 0"
                      >
                        <div
                          class="foto-preview-item"
                          *ngFor="let foto of item.fotosPreview; let fi = index"
                        >
                          <img [src]="foto" alt="Foto del dispositivo" />
                          <button
                            type="button"
                            class="foto-delete"
                            (click)="eliminarFoto(i, fi)"
                          >
                            <i class="pi pi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="form-column">
          <!-- Observaciones generales -->
          <section class="section-card section-compact">
            <div class="section-header-inline">
              <i class="pi pi-comment section-icon-sm"></i>
              <h3>Observaciones</h3>
            </div>
            <div class="form-group-compact">
              <textarea
                id="observaciones"
                [(ngModel)]="observacionesEntrega"
                name="observaciones"
                rows="3"
                placeholder="Notas adicionales sobre la entrega..."
                class="textarea-compact"
              ></textarea>
            </div>
          </section>
          <!-- Resumen + Botones -->
          <section
            class="section-card section-compact summary-section"
            *ngIf="dispositivosSeleccionados.length > 0"
          >
            <div class="section-header-inline">
              <i class="pi pi-check-circle section-icon-sm success"></i>
              <h3>Resumen</h3>
            </div>

            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">Receptor</span>
                <span class="summary-value">{{ receptor.nombre || "-" }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Cargo</span>
                <span class="summary-value">{{ receptor.cargo || "-" }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Correo</span>
                <span class="summary-value">{{ receptor.correo || "-" }}</span>
              </div>
              <div class="summary-item highlight">
                <span class="summary-label">Dispositivos</span>
                <span class="summary-value">{{
                  dispositivosSeleccionados.length
                }}</span>
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="section-footer">
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-accent btn-compact"
                [disabled]="
                  loading ||
                  enviandoCorreo ||
                  dispositivosSeleccionados.length === 0 ||
                  !receptor.nombre ||
                  !receptor.correo
                "
                [class.loading]="loading || enviandoCorreo"
              >
                <i
                  class="pi"
                  [ngClass]="
                    loading || enviandoCorreo ? 'pi-spin pi-spinner' : 'pi-send'
                  "
                ></i>
                {{
                  loading
                    ? "Creando..."
                    : enviandoCorreo
                      ? "Enviando..."
                      : "Crear y Enviar"
                }}
              </button>
            </div>
          </section>

          <!-- Si no hay dispositivos seleccionados, mostrar mensaje -->
          <section
            class="section-card section-compact empty-summary"
            *ngIf="dispositivosSeleccionados.length === 0"
          >
            <div class="empty-summary-content">
              <i class="pi pi-arrow-left"></i>
              <p>Selecciona al menos un dispositivo para crear el acta</p>
            </div>
            <div class="section-footer">
              <button
                type="button"
                class="btn btn-secondary btn-compact"
                (click)="cancelar()"
              >
                <i class="pi pi-times"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-accent btn-compact" disabled>
                <i class="pi pi-send"></i> Crear y Enviar
              </button>
            </div>
          </section>
        </div>
      </div>
    </form>
  </div>
</div>

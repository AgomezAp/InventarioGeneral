<app-navbar></app-navbar>

<div class="actas-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1><i class="pi pi-file"></i> Actas de Entrega</h1>
        <p class="subtitle">
          Gestión de préstamos y devoluciones de dispositivos
        </p>
      </div>

      <div class="header-actions">
        <button class="btn btn-secondary" (click)="irAInventario()">
          <i class="pi pi-box"></i> Ver Inventario
        </button>
        <button class="btn btn-accent" (click)="irACrearActa()">
          <i class="pi pi-plus"></i> Nueva Acta
        </button>
      </div>
    </div>
  </header>

  <!-- Estadísticas rápidas -->
  <section class="stats-section">
    <div class="stats-grid">
      <div class="stat-card stat-pendientes">
        <div class="stat-icon">
          <i class="pi pi-envelope"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarPendientesFirma() }}</span>
          <span class="stat-label">Pend. Firma</span>
        </div>
      </div>

      <div class="stat-card stat-activas">
        <div class="stat-icon">
          <i class="pi pi-clock"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarActivas() }}</span>
          <span class="stat-label">Activas</span>
        </div>
      </div>

      <div class="stat-card stat-parciales">
        <div class="stat-icon">
          <i class="pi pi-exclamation-circle"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarParciales() }}</span>
          <span class="stat-label">Parciales</span>
        </div>
      </div>

      <div class="stat-card stat-completas">
        <div class="stat-icon">
          <i class="pi pi-check-circle"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarCompletas() }}</span>
          <span class="stat-label">Completas</span>
        </div>
      </div>

      <div class="stat-card stat-rechazadas" *ngIf="contarRechazadas() > 0">
        <div class="stat-icon">
          <i class="pi pi-times-circle"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarRechazadas() }}</span>
          <span class="stat-label">Rechazadas</span>
        </div>
      </div>

      <div class="stat-card stat-canceladas" *ngIf="contarCanceladas() > 0">
        <div class="stat-icon">
          <i class="pi pi-ban"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ contarCanceladas() }}</span>
          <span class="stat-label">Canceladas</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="filtros-section">
    <div class="filtros-wrapper">
      <div class="filtro-select">
        <div class="custom-select-wrapper">
          <select
            [(ngModel)]="filtroEstado"
            (change)="aplicarFiltros()"
            class="custom-select"
          >
            <option value="todas">Todos los estados</option>
            <option *ngFor="let estado of estados" [value]="estado">
              {{ getEstadoLabel(estado) }}
            </option>
          </select>
          <i class="pi pi-chevron-down select-arrow"></i>
        </div>
      </div>

      <div class="filtro-busqueda">
        <i class="pi pi-search"></i>
        <input
          type="text"
          [(ngModel)]="filtroBusqueda"
          (input)="aplicarFiltros()"
          placeholder="Buscar por número de acta o receptor..."
          class="search-input"
        />
      </div>
    </div>
  </section>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando actas...</p>
  </div>

  <!-- Lista de actas -->
  <section class="actas-section" *ngIf="!loading">
    <div class="actas-grid">
      <article
        class="acta-card"
        *ngFor="let acta of actasFiltradas"
        [ngClass]="'acta-estado-' + acta.estado"
        (click)="verDetalle(acta)"
        tabindex="0"
        (keydown.enter)="verDetalle(acta)"
      >
        <div class="acta-card-header">
          <span class="acta-numero">{{ acta.numeroActa }}</span>
          <span class="badge" [ngClass]="getEstadoClass(acta.estado)">
            <i class="pi" [ngClass]="getEstadoIcon(acta.estado)"></i>
            {{ getEstadoLabel(acta.estado) }}
          </span>
        </div>

        <div class="acta-card-body">
          <div class="receptor-info">
            <div class="receptor-avatar">
              <i class="pi pi-user"></i>
            </div>
            <div class="receptor-details">
              <strong>{{ acta.nombreReceptor }}</strong>
              <span>{{ acta.cargoReceptor }}</span>
            </div>
          </div>

          <div class="acta-meta">
            <div class="meta-item">
              <i class="pi pi-calendar"></i>
              <span>{{ acta.fechaEntrega | date: "dd/MM/yyyy" }}</span>
            </div>

            <div class="meta-item">
              <i class="pi pi-box"></i>
              <span>{{ acta.detalles?.length || 0 }} dispositivo(s)</span>
              <span class="meta-pendientes" *ngIf="contarPendientes(acta) > 0">
                ({{ contarPendientes(acta) }} pendiente(s))
              </span>
            </div>
          </div>

          <!-- Lista de dispositivos en la tarjeta -->
          <div class="card-productos" *ngIf="acta.detalles && acta.detalles.length > 0">
            <div class="card-producto-item" *ngFor="let detalle of acta.detalles">
              <i class="pi" [ngClass]="getCategoriaIcon(detalle.dispositivo?.categoria || '')"></i>
              <div class="card-producto-info">
                <span class="card-producto-nombre">{{ detalle.dispositivo?.nombre }}</span>
                <span class="card-producto-detalle">{{ detalle.dispositivo?.marca }} {{ detalle.dispositivo?.modelo }}<span *ngIf="detalle.dispositivo?.serial"> - S/N: {{ detalle.dispositivo?.serial }}</span></span>
              </div>
              <span class="badge badge-sm" [ngClass]="detalle.devuelto ? 'badge-devuelto' : 'badge-pendiente'" *ngIf="acta.estado === 'activa' || acta.estado === 'devuelta_parcial'">
                {{ detalle.devuelto ? 'Dev.' : 'Pend.' }}
              </span>
            </div>
          </div>
        </div>

        <div class="acta-card-footer">
          <!-- Actas pendientes de firma -->
          <ng-container *ngIf="acta.estado === 'pendiente_firma'">
            <button
              class="btn btn-sm btn-outline"
              (click)="reenviarCorreo(acta); $event.stopPropagation()"
              [disabled]="reenviandoCorreo[acta.id!]"
            >
              <i
                class="pi"
                [ngClass]="
                  reenviandoCorreo[acta.id!] ? 'pi-spin pi-spinner' : 'pi-send'
                "
              ></i>
              {{
                reenviandoCorreo[acta.id!] ? "Enviando..." : "Reenviar Correo"
              }}
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="cancelarActa(acta); $event.stopPropagation()"
              [disabled]="cancelandoActa[acta.id!]"
            >
              <i
                class="pi"
                [ngClass]="
                  cancelandoActa[acta.id!] ? 'pi-spin pi-spinner' : 'pi-ban'
                "
              ></i>
              {{
                cancelandoActa[acta.id!] ? "Cancelando..." : "Cancelar"
              }}
            </button>
          </ng-container>

          <!-- Actas rechazadas -->
          <ng-container *ngIf="acta.estado === 'rechazada'">
            <button
              class="btn btn-sm btn-outline"
              (click)="enviarNuevoCorreo(acta); $event.stopPropagation()"
              [disabled]="reenviandoCorreo[acta.id!]"
            >
              <i
                class="pi"
                [ngClass]="
                  reenviandoCorreo[acta.id!]
                    ? 'pi-spin pi-spinner'
                    : 'pi-envelope'
                "
              ></i>
              {{
                reenviandoCorreo[acta.id!]
                  ? "Enviando..."
                  : "Enviar Nueva Solicitud"
              }}
            </button>
          </ng-container>

          <!-- Actas activas o parciales -->
          <ng-container
            *ngIf="
              acta.estado === 'activa' || acta.estado === 'devuelta_parcial'
            "
          >
            <button
              class="btn btn-sm btn-accent"
              (click)="abrirModalDevolucion(acta); $event.stopPropagation()"
            >
              <i class="pi pi-replay"></i> Registrar Devolución
            </button>
          </ng-container>
        </div>
      </article>
    </div>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="actasFiltradas.length === 0">
      <div class="empty-icon">
        <i class="pi pi-folder-open"></i>
      </div>
      <h3>No se encontraron actas</h3>
      <p>Intenta ajustar los filtros o crea una nueva acta</p>
    </div>
  </section>

  <!-- Modal de detalle -->
  <div
    class="modal-overlay"
    *ngIf="actaSeleccionada"
    (click)="cerrarDetalle()"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modal-detalle-titulo"
  >
    <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 id="modal-detalle-titulo">
          <i class="pi pi-file"></i> {{ actaSeleccionada.numeroActa }}
        </h2>
        <span class="badge" [ngClass]="getEstadoClass(actaSeleccionada.estado)">
          <i class="pi" [ngClass]="getEstadoIcon(actaSeleccionada.estado)"></i>
          {{ getEstadoLabel(actaSeleccionada.estado) }}
        </span>
        <button class="btn-close" (click)="cerrarDetalle()" aria-label="Cerrar">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Sección Receptor -->
        <div class="detail-section">
          <div class="detail-section-header">
            <i class="pi pi-user"></i>
            <h4>Receptor</h4>
          </div>
          <div class="detail-section-body">
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Nombre</span>
                <span class="detail-value">{{
                  actaSeleccionada.nombreReceptor
                }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Cargo</span>
                <span class="detail-value">{{
                  actaSeleccionada.cargoReceptor
                }}</span>
              </div>
              <div class="detail-item" *ngIf="actaSeleccionada.cedulaReceptor">
                <span class="detail-label">Cédula</span>
                <span class="detail-value">{{
                  actaSeleccionada.cedulaReceptor
                }}</span>
              </div>
              <div
                class="detail-item"
                *ngIf="actaSeleccionada.telefonoReceptor"
              >
                <span class="detail-label">Teléfono</span>
                <span class="detail-value">{{
                  actaSeleccionada.telefonoReceptor
                }}</span>
              </div>
              <div
                class="detail-item"
                *ngIf="actaSeleccionada.correoReceptor"
              >
                <span class="detail-label">Correo</span>
                <span class="detail-value detail-email">{{
                  actaSeleccionada.correoReceptor
                }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Fechas -->
        <div class="detail-section">
          <div class="detail-section-header">
            <i class="pi pi-calendar"></i>
            <h4>Fechas</h4>
          </div>
          <div class="detail-section-body">
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Entrega</span>
                <span class="detail-value">{{
                  actaSeleccionada.fechaEntrega | date: "dd/MM/yyyy HH:mm"
                }}</span>
              </div>
              <div
                class="detail-item"
                *ngIf="actaSeleccionada.fechaFirma"
              >
                <span class="detail-label">Firma</span>
                <span class="detail-value">{{
                  actaSeleccionada.fechaFirma | date: "dd/MM/yyyy HH:mm"
                }}</span>
              </div>
              <div
                class="detail-item"
                *ngIf="actaSeleccionada.fechaDevolucionEsperada"
              >
                <span class="detail-label">Devolución esperada</span>
                <span class="detail-value">{{
                  actaSeleccionada.fechaDevolucionEsperada | date: "dd/MM/yyyy"
                }}</span>
              </div>
              <div
                class="detail-item"
                *ngIf="actaSeleccionada.fechaDevolucionReal"
              >
                <span class="detail-label">Devolución real</span>
                <span class="detail-value">{{
                  actaSeleccionada.fechaDevolucionReal
                    | date: "dd/MM/yyyy HH:mm"
                }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Dispositivos -->
        <div class="detail-section">
          <div class="detail-section-header">
            <i class="pi pi-box"></i>
            <h4>Dispositivos ({{ actaSeleccionada.detalles?.length }})</h4>
          </div>
          <div class="detail-section-body">
            <div class="dispositivos-lista">
              <div
                class="dispositivo-item-expanded"
                *ngFor="let detalle of actaSeleccionada.detalles"
                [class.devuelto]="detalle.devuelto"
              >
                <div class="dispositivo-header-row">
                  <div class="dispositivo-icon">
                    <i
                      class="pi"
                      [ngClass]="
                        getCategoriaIcon(detalle.dispositivo?.categoria || '')
                      "
                    ></i>
                  </div>
                  <div class="dispositivo-info">
                    <strong>{{ detalle.dispositivo?.nombre }}</strong>
                    <span
                      >{{ detalle.dispositivo?.marca }}
                      {{ detalle.dispositivo?.modelo }}</span
                    >
                  </div>
                  <span
                    class="badge"
                    [ngClass]="
                      detalle.devuelto ? 'badge-devuelto' : 'badge-pendiente'
                    "
                  >
                    {{ detalle.devuelto ? "Devuelto" : "Pendiente" }}
                    <span
                      *ngIf="
                        detalle.devuelto &&
                        detalle.estadoDevolucion !== 'disponible'
                      "
                    >
                      ({{ detalle.estadoDevolucion }})
                    </span>
                  </span>
                </div>

                <!-- Detalles extendidos del dispositivo -->
                <div class="dispositivo-detail-grid">
                  <div class="dispositivo-detail" *ngIf="detalle.dispositivo?.serial">
                    <span class="dispositivo-detail-label">Serial</span>
                    <span class="dispositivo-detail-value">{{ detalle.dispositivo?.serial }}</span>
                  </div>
                  <div class="dispositivo-detail" *ngIf="detalle.dispositivo?.imei">
                    <span class="dispositivo-detail-label">IMEI</span>
                    <span class="dispositivo-detail-value">{{ detalle.dispositivo?.imei }}</span>
                  </div>
                  <div class="dispositivo-detail" *ngIf="detalle.dispositivo?.color">
                    <span class="dispositivo-detail-label">Color</span>
                    <span class="dispositivo-detail-value">{{ detalle.dispositivo?.color }}</span>
                  </div>
                  <div class="dispositivo-detail" *ngIf="detalle.dispositivo?.categoria">
                    <span class="dispositivo-detail-label">Categoría</span>
                    <span class="dispositivo-detail-value">{{ detalle.dispositivo?.categoria | titlecase }}</span>
                  </div>
                  <div class="dispositivo-detail" *ngIf="detalle.condicionEntrega">
                    <span class="dispositivo-detail-label">Condición entrega</span>
                    <span class="dispositivo-detail-value badge-condicion" [ngClass]="'condicion-' + detalle.condicionEntrega">{{ detalle.condicionEntrega | titlecase }}</span>
                  </div>
                  <div class="dispositivo-detail" *ngIf="detalle.estadoEntrega">
                    <span class="dispositivo-detail-label">Estado entrega</span>
                    <span class="dispositivo-detail-value">{{ detalle.estadoEntrega | titlecase }}</span>
                  </div>
                </div>

                <div class="dispositivo-obs" *ngIf="detalle.observacionesEntrega">
                  <i class="pi pi-comment"></i>
                  <span>{{ detalle.observacionesEntrega }}</span>
                </div>

                <div class="dispositivo-desc" *ngIf="detalle.dispositivo?.descripcion">
                  <i class="pi pi-info-circle"></i>
                  <span>{{ detalle.dispositivo?.descripcion }}</span>
                </div>

                <!-- Info de devolución si fue devuelto -->
                <div class="dispositivo-devolucion-info" *ngIf="detalle.devuelto">
                  <div class="devolucion-divider">
                    <span>Devolución</span>
                  </div>
                  <div class="dispositivo-detail-grid">
                    <div class="dispositivo-detail" *ngIf="detalle.fechaDevolucion">
                      <span class="dispositivo-detail-label">Fecha</span>
                      <span class="dispositivo-detail-value">{{ detalle.fechaDevolucion | date: "dd/MM/yyyy" }}</span>
                    </div>
                    <div class="dispositivo-detail" *ngIf="detalle.estadoDevolucion">
                      <span class="dispositivo-detail-label">Estado</span>
                      <span class="dispositivo-detail-value">{{ detalle.estadoDevolucion | titlecase }}</span>
                    </div>
                    <div class="dispositivo-detail" *ngIf="detalle.condicionDevolucion">
                      <span class="dispositivo-detail-label">Condición</span>
                      <span class="dispositivo-detail-value badge-condicion" [ngClass]="'condicion-' + detalle.condicionDevolucion">{{ detalle.condicionDevolucion | titlecase }}</span>
                    </div>
                  </div>
                  <div class="dispositivo-obs" *ngIf="detalle.observacionesDevolucion">
                    <i class="pi pi-comment"></i>
                    <span>{{ detalle.observacionesDevolucion }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Observaciones Entrega -->
        <div class="detail-section" *ngIf="actaSeleccionada.observacionesEntrega">
          <div class="detail-section-header">
            <i class="pi pi-comment"></i>
            <h4>Observaciones de entrega</h4>
          </div>
          <div class="detail-section-body">
            <p class="obs-text">{{ actaSeleccionada.observacionesEntrega }}</p>
          </div>
        </div>

        <!-- Sección Observaciones Devolución -->
        <div class="detail-section" *ngIf="actaSeleccionada.observacionesDevolucion">
          <div class="detail-section-header">
            <i class="pi pi-replay"></i>
            <h4>Observaciones de devolución</h4>
          </div>
          <div class="detail-section-body">
            <p class="obs-text">{{ actaSeleccionada.observacionesDevolucion }}</p>
          </div>
        </div>

        <!-- Sección Firma -->
        <div class="detail-section" *ngIf="actaSeleccionada.firmaReceptor">
          <div class="detail-section-header">
            <i class="pi pi-pencil"></i>
            <h4>Firma del receptor</h4>
          </div>
          <div class="detail-section-body">
            <div class="firma-container">
              <img
                [src]="actaSeleccionada.firmaReceptor"
                alt="Firma del receptor"
                class="firma-imagen"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de devolución -->
  <div
    class="modal-overlay"
    *ngIf="mostrarModalDevolucion"
    (click)="cerrarModalDevolucion()"
  >
    <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="pi pi-replay"></i> Registrar Devolución</h2>
        <button
          class="btn-close"
          (click)="cerrarModalDevolucion()"
          aria-label="Cerrar"
        >
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="acta-info-banner">
          <i class="pi pi-file"></i>
          <span
            ><strong>Acta:</strong> {{ devolucionActa?.numeroActa }} -
            {{ devolucionActa?.nombreReceptor }}</span
          >
        </div>

        <div class="devoluciones-lista">
          <div
            class="devolucion-item"
            *ngFor="let item of devoluciones; let i = index"
          >
            <div class="devolucion-header">
              <label class="custom-checkbox">
                <input type="checkbox" [(ngModel)]="item.devolver" />
                <span class="checkmark"></span>
              </label>
              <div class="devolucion-info">
                <strong>{{ item.detalle.dispositivo?.nombre }}</strong>
                <span
                  >{{ item.detalle.dispositivo?.marca }}
                  {{ item.detalle.dispositivo?.modelo }}</span
                >
              </div>
            </div>

            <div class="devolucion-opciones" *ngIf="item.devolver">
              <div class="form-row">
                <div class="form-group">
                  <label>Estado al devolver</label>
                  <div class="custom-select-wrapper">
                    <select
                      [(ngModel)]="item.estadoDevolucion"
                      class="custom-select"
                    >
                      <option value="disponible">
                        Disponible (Vuelve al stock)
                      </option>
                      <option value="dañado">Dañado</option>
                      <option value="perdido">Perdido</option>
                    </select>
                    <i class="pi pi-chevron-down select-arrow"></i>
                  </div>
                </div>

                <div class="form-group">
                  <label>Condición física</label>
                  <div class="custom-select-wrapper">
                    <select
                      [(ngModel)]="item.condicionDevolucion"
                      class="custom-select"
                    >
                      <option value="nuevo">Nuevo</option>
                      <option value="bueno">Bueno</option>
                      <option value="regular">Regular</option>
                      <option value="malo">Malo</option>
                    </select>
                    <i class="pi pi-chevron-down select-arrow"></i>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Observaciones</label>
                <input
                  type="text"
                  [(ngModel)]="item.observaciones"
                  placeholder="Observaciones del dispositivo devuelto"
                  class="custom-input"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Observaciones generales de la devolución</label>
          <textarea
            [(ngModel)]="observacionesDevolucion"
            rows="3"
            placeholder="Observaciones generales..."
            class="custom-textarea"
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModalDevolucion()">
          Cancelar
        </button>
        <button
          class="btn btn-success"
          (click)="registrarDevolucion()"
          [disabled]="loadingDevolucion"
        >
          <i
            class="pi"
            [ngClass]="loadingDevolucion ? 'pi-spin pi-spinner' : 'pi-check'"
          ></i>
          {{ loadingDevolucion ? "Registrando..." : "Registrar Devolución" }}
        </button>
      </div>
    </div>
  </div>
</div>
